python_version: "3.9.13"

new_host_label: "daint.alps"
remotehost: "daint.alps.cscs.ch"
proxy: "ela.cscs.ch"

grants:
  daint.alps:
    - "s1267"
    - "s1276"
    - "s1295"
  tigu:
    - "free"

computers:
  daint.alps:
    setup:
      description: daint.alps at CSCS
      hostname: daint.alps.cscs.ch
      label: daint.alps_cscsaccount
      mpiprocs_per_machine: 256
      mpirun_command: srun --cpu-bind=socket /users/cscsusername/bin/mps-wrapper.sh
      prepend_text: |
        #SBATCH --ntasks-per-core=1
        #SBATCH --hint=nomultithread
        #SBATCH --no-requeue
        #SBATCH --account=cscsaccount
      scheduler: core.slurm
      shebang: "#!/bin/bash -l"
      transport: core.ssh
      use_double_quotes: false
      work_dir: "/capstor/scratch/cscs/{username}/aiida/"
      default_memory_per_machine: 268435456
    config:
      allow_agent: true
      compress: true
      gss_auth: false
      gss_deleg_creds: false
      gss_host: daint.alps.cscs.ch
      gss_kex: false
      key_filename: /home/jovyan/.ssh/cscs-key
      key_policy: RejectPolicy
      load_system_host_keys: true
      look_for_keys: true
      port: 22
      proxy_command: ''
      proxy_jump: ela.cscs.ch
      safe_interval: 30.0
      timeout: 60
      use_login_shell: true
      username: cscsusername

# SSH Configuration from 'config' File
ssh_config: 
  daint.alps.cscs.ch:
    hostname: daint.alps.cscs.ch
    user: cscsusername
    port: 22
    proxy_jump: ela.cscs.ch
    identity_file: /home/jovyan/.ssh/cscs-key
    server_alive_interval: 5
  ela.cscs.ch:
    hostname: ela.cscs.ch
    user: cscsusername
    port: 22
    identity_file: /home/jovyan/.ssh/cscs-key

      
# bashrc to enable conda
bashrc: |
  # Sample .bashrc for SuSE Linux
  # Copyright (c) SuSE GmbH Nuernberg

  # There are 3 different types of shells in bash: the login shell, normal shell
  # and interactive shell. Login shells read ~/.profile and interactive shells
  # read ~/.bashrc; in our setup, /etc/profile sources ~/.bashrc - thus all
  # settings made here will also take effect in a login shell.
  #
  # NOTE: It is recommended to make language settings in ~/.profile rather than
  # here, since multilingual X sessions would not work properly if LANG is over-
  # ridden in every subshell.

  # Some applications read the EDITOR variable to determine your favourite text
  # editor. So uncomment the line below and enter the editor of your choice :-)
  #export EDITOR=/usr/bin/vim
  #export EDITOR=/usr/bin/mcedit

  # For some news readers it makes sense to specify the NEWSSERVER variable here
  #export NEWSSERVER=your.news.server

  # If you want to use a Palm device with Linux, uncomment the two lines below.
  # For some (older) Palm Pilots, you might need to set a lower baud rate
  # e.g. 57600 or 38400; lowest is 9600 (very slow!)
  #
  #export PILOTPORT=/dev/pilot
  #export PILOTRATE=115200

  test -s ~/.alias && . ~/.alias || true

  # >>> conda initialize >>>
  # !! Contents within this block are managed by conda init !!
  __conda_setup=""
  if [ 126 -eq 0 ]; then
      eval ""
  else
      if [ -f /users/cscsusername/miniconda3/etc/profile.d/conda.sh ]; then
          . /users/cscsusername/miniconda3/etc/profile.d/conda.sh
      else
          export PATH=/users/cscsusername/miniconda3/bin:/opt/conda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/home/jovyan/.local/bin
      fi
  fi
  unset __conda_setup
  # <<< conda initialize <<<

# Computational Tools
codes:
  stm:
    append_text: ' '
    computer: daint.alps
    default_calc_job_plugin: nanotech_empa.stm
    description: "stm 1.5.0:1658742098 on daint.alps from https://github.com/nanotech-empa/cp2k-spm-tools.git"
    filepath_executable: "/user-environment/env/default/bin/cp2k-stm-sts-wfn"
    label: stm-1.5.0
    prepend_text: |
      #SBATCH --uenv=cp2k-spm-tools/1.5.0:1658742098
      #SBATCH --view=default
      # set environment
      export MPICH_MALLOC_FALLBACK=1
      export OMP_NUM_THREADS=$((SLURM_CPUS_PER_TASK - 1))
      export MPICH_GPU_SUPPORT_ENABLED=0
      ulimit -s unlimited
    use_double_quotes: false
  
  python:
    append_text: ' '
    computer: daint.alps
    default_calc_job_plugin: pythonjob.pythonjob
    description: "python at daint alps"
    filepath_executable: "/users/cscsusername/miniconda3/envs/py39/bin/python"
    label: python-py39
    prepend_text: |
      conda activate py39
      export MPICH_GPU_SUPPORT_ENABLED=0
    use_double_quotes: false

  pw:
    append_text: ' '
    computer: daint.alps
    default_calc_job_plugin: quantumespresso.pw
    description: "pw.x 7.4:v2"
    filepath_executable: "/user-environment/env/default/bin/pw.x"
    label: pw-7.4:v2
    prepend_text: |
      #SBATCH --uenv=quantumespresso/v7.4:v2
      # set environment
      export MPICH_GPU_SUPPORT_ENABLED=1
      export MPICH_SMP_SINGLE_COPY_MODE=xpmem
      export MPICH_MALLOC_FALLBACK=1
      export OMP_NUM_THREADS=$((SLURM_CPUS_PER_TASK - 1))
      export OMP_PLACES=threads
      ulimit -s unlimited
    use_double_quotes: false

  pp:
    append_text: ' '
    computer: daint.alps
    default_calc_job_plugin: quantumespresso.pp
    description: "pp.x 7.4:v2"
    filepath_executable: "/user-environment/env/default/bin/pp.x"
    label: pp-7.4:v2
    prepend_text: |
      #SBATCH --uenv=quantumespresso/v7.4:v2
      # set environment
      export MPICH_GPU_SUPPORT_ENABLED=1
      export MPICH_SMP_SINGLE_COPY_MODE=xpmem
      export MPICH_MALLOC_FALLBACK=1
      export OMP_NUM_THREADS=$((SLURM_CPUS_PER_TASK - 1))
      export OMP_PLACES=threads
      ulimit -s unlimited
    use_double_quotes: false

  projwfc:
    append_text: ' '
    computer: daint.alps
    default_calc_job_plugin: quantumespresso.projwfc
    description: "projwfc.x 7.4:v2"
    filepath_executable: "/user-environment/env/default/bin/projwfc.x"
    label: projwfc-7.4:v2
    prepend_text: |
      #SBATCH --uenv=quantumespresso/v7.4:v2
      # set environment
      export MPICH_GPU_SUPPORT_ENABLED=1
      export MPICH_SMP_SINGLE_COPY_MODE=xpmem
      export MPICH_MALLOC_FALLBACK=1
      export OMP_NUM_THREADS=$((SLURM_CPUS_PER_TASK - 1))
      export OMP_PLACES=threads
      ulimit -s unlimited
    use_double_quotes: false

  dos:
    append_text: ' '
    computer: daint.alps
    default_calc_job_plugin: quantumespresso.dos
    description: "dos.x 7.4:v2"
    filepath_executable: "/user-environment/env/default/bin/dos.x"
    label: dos-7.4:v2
    prepend_text: |
      #SBATCH --uenv=quantumespresso/v7.4:v2
      # set environment
      export MPICH_GPU_SUPPORT_ENABLED=1
      export MPICH_SMP_SINGLE_COPY_MODE=xpmem
      export MPICH_MALLOC_FALLBACK=1
      export OMP_NUM_THREADS=$((SLURM_CPUS_PER_TASK - 1))
      export OMP_PLACES=threads
      ulimit -s unlimited
    use_double_quotes: false

  phonopy:
    append_text: ' '
    computer: daint.alps
    default_calc_job_plugin: phonopy.phonopy
    description: "phonopy at daint alps"
    filepath_executable: "/users/cscsusername/miniconda3/envs/phonopy/bin/phonopy"
    label: phonopy
    prepend_text: |
      export MPICH_MALLOC_FALLBACK=1
      export OMP_NUM_THREADS=$((SLURM_CPUS_PER_TASK - 1))
      export MPICH_GPU_SUPPORT_ENABLED=0
      ulimit -s unlimited
      conda activate phonopy
    use_double_quotes: false

  overlap:
    append_text: ' '
    computer: daint.alps
    default_calc_job_plugin: nanotech_empa.overlap
    description: "overlap 1.5.0:1658742098 on daint.alps from https://github.com/nanotech-empa/cp2k-spm-tools.git"
    filepath_executable: "/user-environment/env/default/bin/cp2k-overlap-from-wfns"
    label: overlap-1.5.0
    prepend_text: |
      #SBATCH --uenv=cp2k-spm-tools/1.5.0:1658742098
      #SBATCH --view=default
      # set environment
      export MPICH_MALLOC_FALLBACK=1
      export OMP_NUM_THREADS=$((SLURM_CPUS_PER_TASK - 1))
      export MPICH_GPU_SUPPORT_ENABLED=0
      ulimit -s unlimited
    use_double_quotes: 'False'

  critic2:
    append_text: ' '
    computer: daint.alps
    default_calc_job_plugin: critic2
    description: "critic2 at daint alps"
    filepath_executable: "/users/cscsusername/critic2/build/src/critic2"
    label: critic2
    prepend_text: "export MPICH_GPU_SUPPORT_ENABLED=0"
    use_double_quotes: 'False'

  cp2k:
    append_text: ' '
    computer: daint.alps
    default_calc_job_plugin: cp2k
    description: "cp2k 2024.3:v2 on daint.alps"
    filepath_executable: "/user-environment/env/cp2k/bin/cp2k.psmp"
    label: cp2k-2024.3:v2
    prepend_text: |
      #SBATCH --uenv=cp2k/2024.3:v2
      #SBATCH --view=cp2k
      # set environment
      export CP2K_DATA_DIR=/users/cscsusername/src/cp2k/data
      export CUDA_CACHE_PATH="/dev/shm/$RANDOM"
      export MPICH_GPU_SUPPORT_ENABLED=1
      export MPICH_MALLOC_FALLBACK=1
      export OMP_NUM_THREADS=$((SLURM_CPUS_PER_TASK - 1))
      ulimit -s unlimited
    use_double_quotes: 'False'

custom_installations:
